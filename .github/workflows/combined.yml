name: Build Foxy Combined

on:
  push:
    branches: main
    paths:
      - .github/workflows/combined.yml
      - deps.txt
      - vcpkg/**
      - nuspec/combined.nuspec
      - patches/combined.patch
      - repos/combined.repos
  workflow_dispatch:

jobs:
  Build:
    env:
      INSTALL_DIR: C:/opt/ros/foxy/x64
      VCPKG_BINARY_SOURCES: 'clear;nuget,GitHub,readwrite'
      WORKSPACES: foxy;moveit2
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          submodules: true
      - name: Remove existing vcpkg and python
        env:
          GITHUB_USER: ${{ secrets.GITHUB_USER }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p C:/opt/ros/foxy/ros2-foxy-combined
          hub release show ros2-foxy-combined >> description.txt
          sed -i -e '$d' description.txt
          echo "Last updated: "$(date) >> description.txt 
          hub release delete ros2-foxy-combined
          hub release create -F description.txt -a C:/opt/ros/foxy/ros2-foxy-combined.zip ros2-foxy-combined
          rm -rf "$VCPKG_INSTALLATION_ROOT"
          rm -rf "C:/hostedtoolcache/windows/python/"
          rm -rf "C:/Miniconda"
        shell: 'bash'
      - name: Install Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.8.3'
      - name: Update Windows SDK
        uses: fbactions/setup-winsdk@v1
        with:
          winsdk-build-version: 19041
      - name: Setup Environment
        working-directory: C:/
        run: |
          pip install -U vcstool colcon-common-extensions catkin_pkg cryptography EmPy ifcfg lark-parser lxml numpy pyparsing pyyaml
          Move-Item -Path '${{ github.workspace }}/vcpkg' -Destination C:/vcpkg
          ./vcpkg/bootstrap-vcpkg.bat
          & (./vcpkg/vcpkg fetch nuget | Select-Object -Last 1) `
            sources add `
              -source "https://nuget.pkg.github.com/Ace314159/index.json" `
              -storepasswordincleartext `
              -name "GitHub" `
              -username "Ace314159" `
              -password "${{ secrets.GITHUB_TOKEN }}"
          ./vcpkg/vcpkg.exe --triplet=x64-windows install '@${{ github.workspace }}/deps.txt'
          New-Item -Path ${{ env.INSTALL_DIR }} -ItemType SymbolicLink -Value C:/vcpkg/installed/x64-windows/ -Force
          Install-Module Pscx -Scope CurrentUser -Force -AllowClobber
      - name: Clone Repos
        run: |
          mkdir C:/ws/src
      - name: Build
        working-directory: C:/ws
        run: |
          Invoke-BatchFile "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          $env:PYTHONPATH = "C:/opt/ros/foxy/x64/Lib/site-packages;" + $env:PYTHONPATH
          $env:PATH = "C:\opt\ros\foxy\x64\opt\yaml_cpp_vendor\bin;C:\opt\ros\foxy\x64\opt\rviz_ogre_vendor\bin;C:\opt\ros\foxy\x64\opt\libcurl_vendor\bin;C:\opt\ros\foxy\x64\Scripts;C:\opt\ros\foxy\x64\bin;" + $env:PATH
          $env:CMAKE_PREFIX_PATH = "C:\opt\ros\foxy\x64;" + $env:CMAKE_PREFIX_PATH
          colcon build `
            --merge-install `
            --install-base ${{ env.INSTALL_DIR }} `
            --event-handlers console_cohesion+ status- `
            --cmake-args `
              -G Ninja `
              -DCMAKE_BUILD_TYPE=RelWithDebInfo `
              -DVCPKG_BUILD_TYPE=Release `
              -DBUILD_TESTING=False `
              -DBUILD_EXAMPLES=False `
              -DBUILD_UNIT_TESTS=False `
              -DCMAKE_TOOLCHAIN_FILE="C:/vcpkg/scripts/buildsystems/vcpkg.cmake" `
              -DCMAKE_SYSTEM_VERSION="10.0.19041.0" `
              -Wno-dev
      - name: Fix Installation
        working-directory: ${{ env.INSTALL_DIR }}
        run: |
          $files = Get-ChildItem -Recurse -Path * -Include *.cmake
          foreach ($file in $files) {
            (Get-Content $file).replace('C:/vcpkg/installed/x64-windows/', 'C:/opt/ros/foxy/x64/') | Set-Content $file
            (Get-Content $file) -replace 'C:/vcpkg/packages/.+/include', 'C:/opt/ros/foxy/x64/include' | Set-Content $file
          }
          $files = Get-ChildItem -Path Scripts/* -Include *.py
          foreach ($file in $files) {
            (Get-Content $file).replace('c:\hostedtoolcache\windows\python\3.8.3\x64\python.exe', 'c:\python38\python.exe') | Set-Content $file
          }
      - name: Package
        run: |
          cd C:/opt/ros/foxy
          zip -r ros2-foxy-combined.zip C:/opt/ros/foxy
      - name: Release
        env:
          GITHUB_USER: ${{ secrets.GITHUB_USER }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          hub release show ros2-foxy-combined >> description.txt
          sed -i -e '$d' description.txt
          echo "Last updated: "$(date) >> description.txt 
          hub release delete ros2-foxy-combined
          hub release create -F description.txt -a C:/opt/ros/foxy/ros2-foxy-combined.zip ros2-foxy-combined
